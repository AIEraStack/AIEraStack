---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render, getEntry } from 'astro:content';

// Get slug from URL
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/blog');
}

// Get the post
const post = await getEntry('blog', slug);

if (!post) {
  return Astro.redirect('/blog');
}

const { Content } = await render(post);

// Find related posts (same tags, different post)
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const relatedPosts = allPosts
  .filter(p => p.id !== post.id && p.data.tags.some(tag => post.data.tags.includes(tag)))
  .slice(0, 3);

const formattedDate = post.data.publishDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<Layout
  title={`${post.data.title} | AI Era Stack Blog`}
  description={post.data.description}
  ogImage={post.data.image || 'https://aierastack.com/og-image.jpg'}
>
  <article class="max-w-4xl mx-auto px-6 py-16">
    <!-- Back Link -->
    <a
      href="/blog"
      class="inline-flex items-center gap-2 text-[var(--text-muted)] hover:text-cyan-400 transition-colors mb-8"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Blog
    </a>

    <!-- Header -->
    <header class="mb-12">
      <!-- Tags -->
      <div class="flex flex-wrap gap-2 mb-4">
        {post.data.tags.map((tag) => (
          <span class="px-3 py-1 text-sm rounded-full bg-cyan-500/20 text-cyan-400">
            {tag}
          </span>
        ))}
      </div>

      <!-- Title -->
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-6 leading-tight">
        {post.data.title}
      </h1>

      <!-- Meta -->
      <div class="flex items-center gap-4 text-[var(--text-muted)]">
        <span class="font-medium">{post.data.author}</span>
        <span class="text-[var(--border-color)]">â€¢</span>
        <time datetime={post.data.publishDate.toISOString()}>
          {formattedDate}
        </time>
      </div>
    </header>

    <!-- Featured Image -->
    {post.data.image && (
      <div class="mb-12 rounded-2xl overflow-hidden">
        <img
          src={post.data.image}
          alt={post.data.title}
          class="w-full"
        />
      </div>
    )}

    <!-- Content -->
    <div class="prose prose-invert prose-lg max-w-none">
      <Content />
    </div>

    <!-- Author & Share -->
    <div class="mt-16 pt-8 border-t border-[var(--border-color)]">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center text-white font-bold">
            {post.data.author.charAt(0)}
          </div>
          <div>
            <p class="font-medium text-white">{post.data.author}</p>
            <p class="text-sm text-[var(--text-muted)]">AI Era Stack Team</p>
          </div>
        </div>

        <!-- Share Buttons -->
        <div class="flex items-center gap-3">
          <a
            href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.data.title)}&url=${encodeURIComponent(`https://aierastack.com/blog/${post.id}`)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="p-2 rounded-lg bg-[var(--bg-surface)] text-[var(--text-muted)] hover:text-cyan-400 hover:bg-cyan-500/10 transition-all"
            title="Share on Twitter"
          >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
            </svg>
          </a>
          <button
            id="copy-link"
            class="p-2 rounded-lg bg-[var(--bg-surface)] text-[var(--text-muted)] hover:text-cyan-400 hover:bg-cyan-500/10 transition-all"
            title="Copy link"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <div class="mt-16 pt-8 border-t border-[var(--border-color)]">
        <h2 class="text-2xl font-bold text-white mb-8">Related Posts</h2>
        <div class="grid md:grid-cols-3 gap-6">
          {relatedPosts.map((related) => (
            <a
              href={`/blog/${related.id}`}
              class="group bg-[var(--bg-card)] border border-[var(--border-color)] rounded-xl p-6 hover:border-cyan-500/50 transition-all"
            >
              <h3 class="font-semibold text-white group-hover:text-cyan-400 transition-colors line-clamp-2 mb-2">
                {related.data.title}
              </h3>
              <p class="text-sm text-[var(--text-muted)] line-clamp-2">
                {related.data.description}
              </p>
            </a>
          ))}
        </div>
      </div>
    )}
  </article>

  <!-- JSON-LD for SEO -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.data.title,
    "description": post.data.description,
    "author": {
      "@type": "Person",
      "name": post.data.author
    },
    "datePublished": post.data.publishDate.toISOString(),
    "publisher": {
      "@type": "Organization",
      "name": "AI Era Stack",
      "url": "https://aierastack.com"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": `https://aierastack.com/blog/${post.id}`
    }
  })} />
</Layout>

<style is:global>
  /* Prose styles for markdown content */
  .prose {
    color: var(--text-color);
  }
  .prose h1, .prose h2, .prose h3, .prose h4 {
    color: white;
    font-weight: 700;
    margin-top: 2em;
    margin-bottom: 0.75em;
  }
  .prose h1 { font-size: 2.25rem; }
  .prose h2 { font-size: 1.75rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
  .prose h3 { font-size: 1.375rem; }
  .prose h4 { font-size: 1.125rem; }
  .prose p {
    margin-bottom: 1.25em;
    line-height: 1.75;
  }
  .prose a {
    color: #22d3ee;
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  .prose a:hover {
    color: #67e8f9;
  }
  .prose strong {
    color: white;
    font-weight: 600;
  }
  .prose ul, .prose ol {
    margin-bottom: 1.25em;
    padding-left: 1.5em;
  }
  .prose li {
    margin-bottom: 0.5em;
  }
  .prose ul li::marker {
    color: var(--text-muted);
  }
  .prose ol li::marker {
    color: var(--text-muted);
  }
  .prose blockquote {
    border-left: 4px solid #22d3ee;
    padding-left: 1em;
    margin-left: 0;
    margin-bottom: 1.25em;
    color: var(--text-muted);
    font-style: italic;
  }
  .prose code {
    background: var(--bg-surface);
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-size: 0.875em;
    color: #f472b6;
  }
  .prose pre {
    background: var(--bg-surface) !important;
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1.25rem;
    overflow-x: auto;
    margin-bottom: 1.5em;
  }
  .prose pre code {
    background: transparent;
    padding: 0;
    color: var(--text-color);
    font-size: 0.875rem;
  }
  .prose table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.5em;
  }
  .prose th, .prose td {
    border: 1px solid var(--border-color);
    padding: 0.75rem;
    text-align: left;
  }
  .prose th {
    background: var(--bg-surface);
    color: white;
    font-weight: 600;
  }
  .prose hr {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 2em 0;
  }
  .prose img {
    border-radius: 0.75rem;
    margin: 1.5em 0;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  document.getElementById('copy-link')?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      alert('Link copied to clipboard!');
    } catch {
      // Fallback
      const input = document.createElement('input');
      input.value = window.location.href;
      document.body.appendChild(input);
      input.select();
      document.execCommand('copy');
      document.body.removeChild(input);
      alert('Link copied to clipboard!');
    }
  });
</script>
