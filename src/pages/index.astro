---
import Layout from '../layouts/Layout.astro';
import { CuratedStacks } from '../components/home/CuratedStacks';
import { RepoSearch } from '../components/repo/RepoSearch';
import { RotatingAIName } from '../components/ui/RotatingAIName';
import { getFeaturedRepos, getReposByCategory, getRepoIndex } from '../lib/data-loader';
import { CATEGORY_META, type RepoCategory } from '../lib/types';

export const prerender = false;

const env = Astro.locals?.runtime?.env;

const featured = await getFeaturedRepos(env);

// Get repo slugs for autocomplete (sorted by score, top 1000)
const index = await getRepoIndex(env);
const repoSlugs = Object.values(index.repos)
  .sort((a, b) => (b.bestScore || 0) - (a.bestScore || 0))
  .slice(0, 1000)
  .map(r => `${r.owner}/${r.name}`);

const CATEGORY_GROUPS: {
  id: string;
  label: string;
  description: string;
  categories: RepoCategory[];
}[] = [
  {
    id: 'ai',
    label: 'AI & Machine Learning',
    description: 'LLM SDKs and AI frameworks for building intelligent applications.',
    categories: ['ai-python-frameworks', 'ai-js-sdks', 'ai-python-sdks'],
  },
  {
    id: 'frontend-frameworks',
    label: 'Frontend Frameworks',
    description: 'Compare React, Vue, Preact vs Svelte, Astro, Angular, HTMX.',
    categories: ['frontend-frameworks-core', 'frontend-frameworks-alt', 'frontend-frameworks-html'],
  },
  {
    id: 'frontend-ecosystem',
    label: 'Frontend Ecosystem',
    description: 'Meta-frameworks built on top of core frameworks.',
    categories: ['frontend-react-ecosystem', 'frontend-vue-ecosystem', 'frontend-svelte-ecosystem'],
  },
  {
    id: 'backend-frameworks',
    label: 'Backend Frameworks',
    description: 'Compare Go, Python, Rust, and Node.js web frameworks.',
    categories: ['backend-go-web', 'backend-python-web', 'backend-rust-web', 'backend-nodejs-api'],
  },
  {
    id: 'backend-data',
    label: 'Backend Data Layer',
    description: 'ORMs, query builders, and data libraries.',
    categories: ['backend-database-clients', 'backend-go-data', 'backend-rust-data'],
  },
  {
    id: 'data',
    label: 'Data Science',
    description: 'Data processing, machine learning, and visualization.',
    categories: ['data-core', 'data-ml', 'data-apps'],
  },
  {
    id: 'ui-state',
    label: 'UI & State Management',
    description: 'Design systems, headless UI, and state management.',
    categories: ['ui-design-systems', 'ui-headless', 'state-stores', 'state-data-fetching'],
  },
  {
    id: 'tooling',
    label: 'Developer Tooling',
    description: 'Build tools, runtimes, testing, and utilities.',
    categories: ['tooling-bundlers', 'tooling-runtimes', 'tooling-workflow', 'tooling-testing', 'tooling-utilities'],
  },
  {
    id: 'infrastructure',
    label: 'Infrastructure & DevOps',
    description: 'Containers, IaC, and observability tools.',
    categories: ['infra-containers', 'infra-iac', 'infra-observability'],
  },
  {
    id: 'cross-platform',
    label: 'Cross-Platform',
    description: 'Mobile, desktop, and CLI application frameworks.',
    categories: ['cross-platform-mobile', 'cross-platform-desktop', 'cross-platform-cli'],
  },
];

const categoryOrder: RepoCategory[] = CATEGORY_GROUPS.flatMap((group) => group.categories);

const categorizedRepos = await Promise.all(
  categoryOrder.map(async (cat) => {
    const repos = await getReposByCategory(cat, env);
    return {
      category: cat,
      meta: CATEGORY_META[cat],
      repos,
    };
  })
);

const categorizedRepoMap = new Map(categorizedRepos.map((item) => [item.category, item]));

const groupedRepos = CATEGORY_GROUPS.map((group) => {
  const categories = group.categories
    .map((category) => categorizedRepoMap.get(category))
    .filter((item): item is (typeof categorizedRepos)[number] => Boolean(item && item.repos.length > 0));

  return {
    ...group,
    categories,
  };
}).filter((group) => group.categories.length > 0);

const examples = [
  'tanstack/query',
  'vercel/next.js',
  'prisma/prisma',
  'trpc/trpc',
  'colinhacks/zod',
];
---

<Layout title="AI Era Stack - Best Libraries for AI Coding with Cursor, Codex & Claude">
  <section class="relative pt-32 pb-20 px-6 overflow-hidden">
    <div class="max-w-5xl mx-auto text-center relative z-10">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-cyan-900/30 border border-cyan-500/30 text-cyan-400 text-sm font-medium mb-8 animate-fade-in">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-cyan-500"></span>
        </span>
        AI-First Engineering
      </div>
      
      <h1 class="text-5xl md:text-7xl font-bold text-white mb-8 tracking-tight leading-tight">
        Find the best <span class="gradient-text text-glow">stack</span> for <br />
        <span class="gradient-text text-glow">AI Era</span>
      </h1>
      
      <p class="text-xl text-[var(--text-muted)] mb-12 max-w-2xl mx-auto leading-relaxed">
        Stop using libraries <RotatingAIName client:load /> doesn't know. <br />
        Find the LLM that best understands your target stack.
      </p>

      <div class="relative max-w-2xl mx-auto mb-8 group">
        <div class="absolute -inset-1 bg-gradient-to-r from-cyan-500 to-purple-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
        <div class="relative">
          <RepoSearch repoSlugs={repoSlugs} client:load />
        </div>
      </div>

      <p class="text-sm text-[var(--text-muted)]">
        Try: 
        {examples.map((ex, i) => (
          <>
            <a href={`/repo/${ex}`} class="text-cyan-400 hover:text-cyan-300 transition-colors mx-1">{ex}</a>
            {i < examples.length - 1 && <span class="opacity-30">/</span>}
          </>
        ))}
        <span class="opacity-30 mx-2">|</span>
        <a href="/compare" class="text-purple-400 hover:text-purple-300 transition-colors">Compare libraries â†’</a>
      </p>
    </div>
  </section>

  <CuratedStacks groups={groupedRepos} client:load />

  <section class="py-24 px-6 border-t border-[var(--border-color)] bg-[var(--bg-card)]/30">
    <div class="max-w-7xl mx-auto">
      <h2 class="text-3xl font-bold text-white mb-16 text-center">
        How We <span class="gradient-text">Score</span>
      </h2>

      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">ðŸ“¡</div>
          <h3 class="text-lg font-bold text-white mb-3 text-indigo-400">Coverage</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">25%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            How well is this project covered in LLM training data?
          </p>
        </div>

        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">ðŸ“ˆ</div>
          <h3 class="text-lg font-bold text-white mb-3 text-green-400">Adoption</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">20%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            Stars, downloads, and community adoption metrics.
          </p>
        </div>

        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">ðŸ“š</div>
          <h3 class="text-lg font-bold text-white mb-3 text-amber-400">Documentation</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">15%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            README quality, docs, examples, and changelog presence.
          </p>
        </div>

        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">ðŸ¤–</div>
          <h3 class="text-lg font-bold text-white mb-3 text-purple-400">AI Readiness</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">15%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            TypeScript support, llms.txt, and AI-friendly structure.
          </p>
        </div>

        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">âš¡</div>
          <h3 class="text-lg font-bold text-white mb-3 text-cyan-400">Momentum</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">15%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            Recent commit activity and release frequency.
          </p>
        </div>

        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">ðŸ”§</div>
          <h3 class="text-lg font-bold text-white mb-3 text-pink-400">Maintenance</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">10%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            Issue health and PR response time quality.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section class="py-20 px-6 border-t border-[var(--border-color)]">
    <div class="max-w-3xl mx-auto text-center">
      <h2 class="text-3xl font-bold text-white mb-6">
        About <span class="gradient-text">AI Era Stack</span>
      </h2>
      <p class="text-[var(--text-muted)] leading-relaxed">
        AI Era Stack helps developers evaluate how AI-ready a GitHub project is,
        combining public signals with LLM cutoff dates to guide safer stack choices.
      </p>
    </div>
  </section>
</Layout>
