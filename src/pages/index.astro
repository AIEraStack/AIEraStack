---
import Layout from '../layouts/Layout.astro';
import { RepoSearch } from '../components/repo/RepoSearch';
import { RotatingAIName } from '../components/ui/RotatingAIName';
import { getFeaturedRepos, getReposByCategory } from '../lib/data-loader';
import { CATEGORY_META, type RepoCategory } from '../lib/types';
import { LLM_CONFIGS, getLLMById } from '../lib/llm-configs';

export const prerender = false;

const env = Astro.locals?.runtime?.env;

// Get selected LLM from query params, default to gpt-5.2-codex
const url = new URL(Astro.request.url);
const selectedLLMId = url.searchParams.get('llm') || 'gpt-5.2-codex';
const selectedLLM = getLLMById(selectedLLMId) || LLM_CONFIGS[0];

const featured = await getFeaturedRepos(env);

const CATEGORY_GROUPS: {
  id: string;
  label: string;
  description: string;
  categories: RepoCategory[];
}[] = [
  {
    id: 'ai',
    label: 'AI',
    description: 'LLM tooling and Python AI/data libraries.',
    categories: ['ai-ml', 'python-ai', 'python-data'],
  },
  {
    id: 'frontend',
    label: 'Frontend',
    description: 'Frameworks, UI kits, and state management.',
    categories: ['framework', 'ui-library', 'state-management'],
  },
  {
    id: 'backend',
    label: 'Backend',
    description: 'APIs, databases, and Python web.',
    categories: ['api', 'database', 'python-web'],
  },
  {
    id: 'tooling',
    label: 'Tooling',
    description: 'Build, test, and utility tooling.',
    categories: ['build-tool', 'testing', 'utility'],
  },
  {
    id: 'devices',
    label: 'Devices',
    description: 'Mobile, desktop, and cross-platform frameworks.',
    categories: ['mobile', 'desktop', 'cross-platform'],
  },
  {
    id: 'systems',
    label: 'Systems',
    description: 'Languages and infrastructure fundamentals.',
    categories: ['go', 'rust', 'devops'],
  },
];

const categoryOrder: RepoCategory[] = CATEGORY_GROUPS.flatMap((group) => group.categories);

const categorizedRepos = await Promise.all(
  categoryOrder.map(async (cat) => {
    const repos = await getReposByCategory(cat, env);
    const sorted = repos.sort((a, b) => {
      // Sort by selected LLM's score
      const scoreA = a.scoresByLLM?.[selectedLLMId]?.overall || a.bestScore || 0;
      const scoreB = b.scoresByLLM?.[selectedLLMId]?.overall || b.bestScore || 0;
      return scoreB - scoreA;
    });
    return {
      category: cat,
      meta: CATEGORY_META[cat],
      repos: sorted.slice(0, 5),
    };
  })
);

const categorizedRepoMap = new Map(categorizedRepos.map((item) => [item.category, item]));

const groupedRepos = CATEGORY_GROUPS.map((group) => {
  const categories = group.categories
    .map((category) => categorizedRepoMap.get(category))
    .filter((item): item is (typeof categorizedRepos)[number] => Boolean(item && item.repos.length > 0));

  return {
    ...group,
    categories,
  };
}).filter((group) => group.categories.length > 0);

const examples = [
  'tanstack/query',
  'vercel/next.js',
  'prisma/prisma',
  'trpc/trpc',
  'colinhacks/zod',
];
---

<Layout title="AI Era Stack - Pick the right stack for the AI era">
  <section class="relative pt-32 pb-20 px-6 overflow-hidden">
    <div class="max-w-5xl mx-auto text-center relative z-10">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-cyan-900/30 border border-cyan-500/30 text-cyan-400 text-sm font-medium mb-8 animate-fade-in">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-cyan-500"></span>
        </span>
        AI-First Engineering
      </div>
      
      <h1 class="text-5xl md:text-7xl font-bold text-white mb-8 tracking-tight leading-tight">
        Pick your stack for the <br />
        <span class="gradient-text text-glow">AI Era</span>
      </h1>
      
      <p class="text-xl text-[var(--text-muted)] mb-12 max-w-2xl mx-auto leading-relaxed">
        Stop using libraries <RotatingAIName client:load /> doesn't know. <br />
        Find the LLM that best understands your target stack.
      </p>

      <div class="relative max-w-2xl mx-auto mb-8 group">
        <div class="absolute -inset-1 bg-gradient-to-r from-cyan-500 to-purple-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
        <div class="relative">
          <RepoSearch client:load />
        </div>
      </div>

      <p class="text-sm text-[var(--text-muted)]">
        Try: 
        {examples.map((ex, i) => (
          <>
            <a href={`/repo/${ex}`} class="text-cyan-400 hover:text-cyan-300 transition-colors mx-1">{ex}</a>
            {i < examples.length - 1 && <span class="opacity-30">/</span>}
          </>
        ))}
        <span class="opacity-30 mx-2">|</span>
        <a href="/compare" class="text-purple-400 hover:text-purple-300 transition-colors">Compare libraries â†’</a>
      </p>
    </div>
  </section>

  <section class="py-24 px-6 relative">
    <div class="max-w-7xl mx-auto">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4">
        <h2 class="text-3xl font-bold text-white">
          <span class="gradient-text">Curated</span> Stacks
        </h2>
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
          <span class="text-sm text-[var(--text-muted)]">Scored for:</span>
          <div class="flex flex-wrap gap-2">
            {LLM_CONFIGS.map((llm) => (
              <a
                href={`/?llm=${llm.id}`}
                class={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                  selectedLLMId === llm.id
                    ? 'text-white ring-2 ring-offset-2 ring-offset-slate-900'
                    : 'bg-white/5 text-slate-300 hover:bg-white/10 hover:text-white'
                }`}
                style={selectedLLMId === llm.id ? `background-color: ${llm.color}` : ''}
              >
                {llm.name}
              </a>
            ))}
          </div>
        </div>
      </div>

      <div class="space-y-12">
        {groupedRepos.map((group) => (
          <div>
            <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between mb-6">
              <div>
                <h3 class="text-xl font-bold text-white">{group.label}</h3>
                <p class="text-sm text-[var(--text-muted)]">{group.description}</p>
              </div>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
              {group.categories.map((cat) => (
                <div class="glass-card rounded-2xl p-6 hover:-translate-y-1 transition-transform duration-300">
                  <h4 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <span class="text-2xl">{cat.meta.icon}</span>
                    {cat.meta.label}
                  </h4>
                  <div class="space-y-2">
                    {cat.repos.map((repo, i) => {
                      const score = repo.scoresByLLM?.[selectedLLMId]?.overall || repo.bestScore || 0;
                      return (
                        <a
                          href={`/repo/${repo.owner}/${repo.name}`}
                          class="group flex items-center justify-between p-2 rounded-lg hover:bg-white/5 transition-colors"
                        >
                          <div class="flex items-center gap-3 flex-1 min-w-0">
                            <span class={`text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full flex-shrink-0 ${i === 0 ? 'bg-yellow-500/20 text-yellow-500' : 'text-[var(--text-muted)] bg-white/5'}`}>
                              {i + 1}
                            </span>
                            <span class="text-sm text-[var(--text-primary)] font-medium group-hover:text-cyan-400 transition-colors truncate" title={`${repo.owner}/${repo.name}`}>
                              <span class="text-slate-500">{repo.owner}/</span>{repo.name}
                            </span>
                          </div>
                          <div class="flex items-center gap-2 flex-shrink-0">
                            <div class="w-12 h-1 bg-gray-800 rounded-full overflow-hidden">
                              <div
                                class="h-full bg-gradient-to-r from-cyan-500 to-purple-500 rounded-full"
                                style={`width: ${score}%`}
                              />
                            </div>
                            <span class="text-xs font-mono text-cyan-400 w-6">{score}</span>
                          </div>
                        </a>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <section class="py-24 px-6 border-t border-[var(--border-color)] bg-[var(--bg-card)]/30">
    <div class="max-w-7xl mx-auto">
      <h2 class="text-3xl font-bold text-white mb-16 text-center">
        How We <span class="gradient-text">Score</span>
      </h2>

      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">ðŸ“¡</div>
          <h3 class="text-lg font-bold text-white mb-3 text-indigo-400">Coverage</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">25%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            How well is this project covered in LLM training data?
          </p>
        </div>

        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">ðŸ“ˆ</div>
          <h3 class="text-lg font-bold text-white mb-3 text-green-400">Adoption</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">20%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            Stars, downloads, and community adoption metrics.
          </p>
        </div>

        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">ðŸ“š</div>
          <h3 class="text-lg font-bold text-white mb-3 text-amber-400">Documentation</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">15%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            README quality, docs, examples, and changelog presence.
          </p>
        </div>

        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">ðŸ¤–</div>
          <h3 class="text-lg font-bold text-white mb-3 text-purple-400">AI Readiness</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">15%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            TypeScript support, llms.txt, and AI-friendly structure.
          </p>
        </div>

        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">âš¡</div>
          <h3 class="text-lg font-bold text-white mb-3 text-cyan-400">Momentum</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">15%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            Recent commit activity and release frequency.
          </p>
        </div>

        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">ðŸ”§</div>
          <h3 class="text-lg font-bold text-white mb-3 text-pink-400">Maintenance</h3>
          <div class="text-3xl font-mono font-bold text-white mb-4">10%</div>
          <p class="text-sm text-[var(--text-muted)] leading-relaxed">
            Issue health and PR response time quality.
          </p>
        </div>
      </div>
    </div>
  </section>
</Layout>
