---
import Layout from '../../layouts/Layout.astro';
import { RepoAnalyzer } from '../../components/repo/RepoAnalyzer';
import { getCachedRepo } from '../../lib/data-loader';
import type { CachedRepoData } from '../../lib/types';

export const prerender = false;

async function fetchRepoFromApi(owner: string, name: string, request: Request): Promise<CachedRepoData | null> {
  try {
    const apiUrl = new URL('/api/repo', request.url);
    apiUrl.searchParams.set('owner', owner);
    apiUrl.searchParams.set('name', name);
    const response = await fetch(apiUrl);
    if (!response.ok) return null;
    return (await response.json()) as CachedRepoData;
  } catch {
    return null;
  }
}

const { slug } = Astro.params;
const parts = slug?.split('/') || [];
const env = Astro.locals?.runtime?.env;

if (parts.length !== 2) {
  return Astro.redirect('/');
}

const [owner, name] = parts;
const cached = await getCachedRepo(owner, name, env);
let initialData = cached;
if (!initialData) {
  initialData = await fetchRepoFromApi(owner, name, Astro.request);
}

const aiScore = initialData?.analysis?.overall ?? null;

const pageTitle = initialData 
  ? aiScore
    ? `${initialData.repo.name} AI Readiness: ${aiScore}/100 | AI Era Stack`
    : `${initialData.repo.name} - AI Era Stack`
  : `${owner}/${name} - AI Era Stack`;

const pageDescription = initialData?.repo.description 
  ? aiScore 
    ? `${initialData.repo.description} | AI Era Stack Score: ${aiScore}/100 - How AI-ready is this library?`
    : `${initialData.repo.description} - Check AI readiness on AI Era Stack.`
  : `${owner}/${name} - Check how AI-ready this library is on AI Era Stack.`;

const defaultLlmId = 'gpt-5.2-codex';

// Generate JSON-LD for SoftwareApplication schema
const jsonLdSchema = initialData ? {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": initialData.repo.name,
  "description": initialData.repo.description || `${owner}/${name} GitHub repository`,
  "applicationCategory": "DeveloperApplication",
  "operatingSystem": "Cross-platform",
  "url": `https://github.com/${owner}/${name}`,
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": initialData.analysis?.overall ?? 0,
    "bestRating": 100,
    "worstRating": 0,
    "ratingCount": initialData.repo.stars ?? 1
  },
  "author": {
    "@type": initialData.repo.owner?.type === 'Organization' ? "Organization" : "Person",
    "name": owner
  }
} : null;
---

<Layout title={pageTitle} description={pageDescription}>
  {jsonLdSchema && (
    <script type="application/ld+json" set:html={JSON.stringify(jsonLdSchema)} />
  )}
  <div class="max-w-6xl mx-auto px-4 py-8">
    <a href="/" class="inline-flex items-center gap-2 text-slate-400 hover:text-white mb-6 transition-colors">
      ‚Üê Back to search
    </a>

    <RepoAnalyzer
      client:only="react"
      owner={owner}
      name={name}
      initialData={initialData}
      defaultLLMId={defaultLlmId}
    />
  </div>
</Layout>
