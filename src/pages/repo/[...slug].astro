---
import Layout from '../../layouts/Layout.astro';
import { RepoAnalyzer } from '../../components/repo/RepoAnalyzer';
import { getCachedRepo } from '../../lib/data-loader';
import type { CachedRepoData } from '../../lib/types';

export const prerender = false;

async function fetchRepoFromApi(owner: string, name: string, request: Request): Promise<CachedRepoData | null> {
  try {
    const apiUrl = new URL('/api/repo', request.url);
    apiUrl.searchParams.set('owner', owner);
    apiUrl.searchParams.set('name', name);
    const response = await fetch(apiUrl);
    if (!response.ok) return null;
    return (await response.json()) as CachedRepoData;
  } catch {
    return null;
  }
}

const { slug } = Astro.params;
const parts = slug?.split('/') || [];
const env = Astro.locals?.runtime?.env;

if (parts.length !== 2) {
  return Astro.redirect('/');
}

const [owner, name] = parts;
const cached = await getCachedRepo(owner, name, env);
let initialData = cached;
if (!initialData) {
  initialData = await fetchRepoFromApi(owner, name, Astro.request);
}

const pageTitle = initialData 
  ? `${initialData.repo.name} - AI Era Stack`
  : `${owner}/${name} - AI Era Stack`;

const pageDescription = initialData?.repo.description 
  ? `${initialData.repo.description} - See how well AI models understand this project.`
  : `See how well AI models understand ${owner}/${name}`;

const defaultLlmId = 'gpt-5.2-codex';
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="max-w-6xl mx-auto px-4 py-8">
    <a href="/" class="inline-flex items-center gap-2 text-slate-400 hover:text-white mb-6 transition-colors">
      ‚Üê Back to search
    </a>

    <RepoAnalyzer
      client:only="react"
      owner={owner}
      name={name}
      initialData={initialData}
      defaultLLMId={defaultLlmId}
    />
  </div>
</Layout>
