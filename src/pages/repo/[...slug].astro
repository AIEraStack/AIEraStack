---
import Layout from '../../layouts/Layout.astro';
import { RepoAnalyzer } from '../../components/repo/RepoAnalyzer';
import { getCachedRepo } from '../../lib/d1-data-loader';
import { getOrFetchRepo } from '../../lib/repo-fetcher';
import type { CachedRepoData } from '../../lib/types';

export const prerender = false;

const { slug } = Astro.params;
const parts = slug?.split('/') || [];
const env = Astro.locals?.runtime?.env ?? {};
const ctx = Astro.locals?.runtime?.ctx;

if (parts.length !== 2) {
  return Astro.redirect('/');
}
const [owner, name] = parts;
const initialData = await getOrFetchRepo(owner, name, env, getCachedRepo, ctx);

// Calculate best score from all LLMs (matching homepage logic)
const aiScore = initialData?.scores
  ? Math.max(...Object.values(initialData.scores).map(s => s.overall || 0))
  : null;

const pageTitle = initialData 
  ? aiScore
    ? `${initialData.repo.name} AI Readiness: ${aiScore}/100 | AI Era Stack`
    : `${initialData.repo.name} - AI Era Stack`
  : `${owner}/${name} - AI Era Stack`;

const pageDescription = initialData?.repo.description 
  ? aiScore 
    ? `${initialData.repo.description} | AI Era Stack Score: ${aiScore}/100 - How AI-ready is this library?`
    : `${initialData.repo.description} - Check AI readiness on AI Era Stack.`
  : `${owner}/${name} - Check how AI-ready this library is on AI Era Stack.`;

const defaultLlmId = 'gpt-5.2-codex';

// Generate JSON-LD for SoftwareApplication schema
const softwareAppSchema = initialData ? {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": initialData.repo.name,
  "description": initialData.repo.description || `${owner}/${name} GitHub repository`,
  "applicationCategory": "DeveloperApplication",
  "operatingSystem": "Cross-platform",
  "url": `https://github.com/${owner}/${name}`,
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": aiScore ?? 0,
    "bestRating": 100,
    "worstRating": 0,
    "ratingCount": initialData.repo.stars ?? 1
  },
  "author": {
    "@type": initialData.repo.owner?.type === 'Organization' ? "Organization" : "Person",
    "name": owner
  }
} : null;

// Generate BreadcrumbList schema for better navigation in search results
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://aierastack.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": `${owner}/${name}`,
      "item": `https://aierastack.com/repo/${owner}/${name}`
    }
  ]
};

// Combine schemas into an array
const jsonLdSchemas = softwareAppSchema 
  ? [softwareAppSchema, breadcrumbSchema] 
  : [breadcrumbSchema];
---

<Layout title={pageTitle} description={pageDescription} noDefaultJsonLd={true}>
  {jsonLdSchemas.map((schema) => (
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  ))}
  <div class="max-w-6xl mx-auto px-4 py-8">
    <a href="/" class="inline-flex items-center gap-2 text-slate-400 hover:text-white mb-6 transition-colors">
      ‚Üê Back to search
    </a>

    <RepoAnalyzer
      client:only="react"
      owner={owner}
      name={name}
      initialData={initialData}
      defaultLLMId={defaultLlmId}
    />
  </div>
</Layout>
